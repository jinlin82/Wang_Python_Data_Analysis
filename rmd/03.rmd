---
title: "Python编程分析基础"
author: "金林"
date: "2019-03"
output:
  bookdown::html_document2:
    fig_caption: true
    highlight: haddock
    keep_md: true
    md_extensions: +east_asian_line_breaks
    number_sections: true
    pandoc_args:
    - --filter
    - pandoc-crossref
    - -M
    - eqnPrefix=
    seq_numbering: false
    toc: true
  bookdown::pdf_document2:
    keep_tex: true
    latex_engine: xelatex
    md_extensions: +east_asian_line_breaks
    pandoc_args:
    - --listing
    - --filter
    - pandoc-crossref
    toc: false
  slidy_presentation:
    highlight: haddock
  bookdown::word_document2:
    fig_caption: true
    md_extensions: +east_asian_line_breaks
    pandoc_args:
    - --filter
    - pandoc-crossref
    reference_docx: ./style/word-styles-02.docx
  ioslides_presentation:
    highlight: haddock
    slide_level: 3
  beamer_presentation:
    keep_tex: true
    latex_engine: xelatex
    pandoc_args:
    - --listing
    - --filter
    - pandoc-crossref
    slide_level: 3
    template: ./style/beamer-template.tex
csl: ./style/chinese-gb7714-2005-numeric.csl
css: ./style/markdown.css
bibliography: Bibfile.bib
eqnPrefixTemplate: ($$i$$)
institute: 中南财经政法大学统计系
link-citations: true
linkReferences: true
chapters: true
tableEqns: false
autoEqnLabels: false
---


```{r setup, echo=F}
knitr::opts_knit$set(root.dir = getwd())
knitr::opts_chunk$set(echo = TRUE, results = 'hide')
knitr::opts_chunk$set(warning = FALSE, message=FALSE)
```

```{r prepare, echo=F}
rm(list=ls())
options(digits=4)
options(scipen=100)
graphics.off()
Sys.setlocale("LC_ALL", "Chinese")
```

# Python 数据类型

## Python 数据类型
### python对象
python创建和控制的实体称为对象(object),它们可以是变量、数组、字符串、函数或结构。
由于python是一种所见即所得的脚本语言，故不需要编译。在python里，对象是通过名字创
建和保存的。可以用who命令来查看当前打开的python环境里的对象，用del删除这些对象。

1. 查看数据对象
2. 生成数据对象
3. 删除数据对象

上面列出的是新创建的数据对象x的名称。python对象的名称必须以一个英文字母打头，并
由一串大小写字母、数字或下画线组成。注意：python区分大小写，比如，Orange与orange
数据对象是不同的。不要用python的内置函数名作为对象的名称，如who/del等。

```{python, eval=F}
who
x=10.12   
who
del x   
who
```


### 数据的基本类型
python的基本数据类型包括数值型、逻辑型、字符型、复数型等，也可能是缺失值。
1. 数值型

数值型数据的形式是实数，可以写成整数（如=3）、小数（如x=1.46）/科学计数（y=1e9）
d的方式，该类型数据默认是双精度数据。

python支持4种不同的数字类型：
int(有符号整型)；
long（长整型，也可以代表八进制和十六进制）；
flont（浮点型）；
complex（复数）。
说明：python中显示数据或对象内容直接用其名称，相当于执行print函数，见下。

```{python}
n=10       
n
print("n=",n)
x=10.234   
print(x)
print("x=%10.5f"%x)
```

2. 逻辑型

逻辑型数据只能取True或False值。
可以通过比较获得逻辑型数据，
```{python}
a=True;a
b=False;b

10>3
10<3
```

3. 字符型

字符型数据的形式是夹在双引号“”或单引号''之间的字符串，如‘MR’。注意：一定要用
英文引号，不能用中文引号“”或‘’。python语言中的string（字符串）是由数字、字母、
下画线组成的一串字符。一般形式为

s=‘I love python’
它是编程语言中表示文本的数据类型。

另外，python字符串具有切片功能，即由左到右索引默认从0开始；由右到左索引默认从-1
开始。如果要实现从字符串中获取一段子字符串，可以使用变量[头下标：尾下标]，其中下
标从0开始算起，可以是正数或负数，也可以为空，表示取到头或尾。比如，上例中s[7]的
值是p，s[2：6]的结果是love.

```{python}
s='IlovePython';s
s[7]
s[2:6]
s+s
s*2
```
加号（+）是字符串连接运算符，星号（*）是重复操作。

4. 缺失值

有些统计资料是不完整的。当一个元素或值在统计的时候是“不可得到”或“缺失值”的时
候，相关位置可能会被保留并且赋予一个特定的nan（not availablenumber，不是一个数）
值。任何nan的运算结果都是nan。例如，float（‘nan’）就是一个实数缺失值。

```{python}
float('nan')
```


5. 数据类型转换

有时，需要对数据内置的类型进行转换，只须将数据类型作为函数名即可。以下几个内置的
函数可以实现数据类型之间的转换。这些函数返回一个新的对象，表示转换的值。下面列出
几种常用的数据类型转换方式：


int（x[,base]）   #将x转换为一个整数
float（x）        #将x转换为一个浮数点
str（x）          #将对象x转换为字符串
chr（x）          #将一个整数转换为一个字符
python的所有数据类型都是类，可以通过type（）查看该变量的数据类型。

### 标准数据类型

在内存中存储的数据可以有多种类型。例如，一个人的年龄可以用数字来存储，名字可以用
字符来存储。python定义了一些标准类型，用于存储各种类型的数据，这些标准的数据类型
是由前述基本类型构成的

1. list（列表）

list（列表）是python中使用最频繁的数据类型。列表可以完成大多数集合类的数据结构实
现。它支持字符、数字、字符串，甚至可以包含列表（即嵌套）。列表用[]标识，是一种最
通用的复合数据类型。python的列表也具有切片功能，列表中值的切割也可以用到变量[头
下标：尾下标]，可以截取相应的列表，从左到右索引默认从0开始，从右到左索引默认从-1
开始，下标可以为空，表示取到头或尾。

```{python}
list1=[] 
list1
list1=['Python',786,2.23,'R',70.2]
list1 
list1[0] 
list1[1:3] 
list1[2:] 
list1*2 
list1+list1[2:4] 
```

加号+是列表连接运算符，星号*是重复操作。操作类似字符串。
```{python}
X=[1,3,6,4,9];X
sex=[' 女',' 男',' 男',' 女',' 男']
sex
weight=[67,66,83,68,70];
weight
```

列表list是我们进行数据分析的基本类型，所以必须掌握。

2. tuple（元组）

元组是另一种数据类型，类似于list（列表）。元组用“()”标识，内部元素用逗号隔开。
元组不能赋值，相当于只读列表。操作类似列表。

3. dictionary（字典）

字典也是一种数据类型，且可存储任意类型对象。字典的每个键值对用冒号“：”分隔，每
个键值对之间用逗号“，”分隔，整个字典包括在花括号｛｝中，格式如下：

dict={key1:value1,key2:value2}

键必须是唯一的，但值则不必，值可以取任何数据类型，如字符串、数字或元组。

字典是除列表外python中最灵活的内置数据结构类型。列表是有序的对象集合，字典是无序的对象集合。

两者之间的区别在于：字典中的元素是通过键来存取的，而不是通过下标存取。
```{python}
{}            
dict1={'name':'john','code':6734,'dept':'sales'};dict1 
dict1['code']  
dict1.keys()   
dict1.values() 

dict2={'sex': sex,'weight':weight}; dict2 
```

## 数值分析库 numpy
在使用numpy库前，须加载其到内存中，语句为import numpy，通常将其简化为
import numpy as np

### 一维数组（向量）
```{python}
import numpy as np       
np.array([1,2,3,4,5])         
np.array([1,2,3,np.nan,5])    

np.array(X)              
np.arange(9)             
np.arange(1,9,0.5)       
np.linspace(1,9,5)       

np.random.randint(1,9)   
np.random.rand(10)       
np.random.randn(10)      
```

### 二维数组（矩阵）
```{python}
np.array([[1,2],[3,4],[5,6]]) 
A=np.arange(9).reshape((3,3));A 
```

### 数组的操作
1. 数组的维度
2. 空数组
3. 零数组
4. 1数组
5. 单位阵
```{python}
A.shape
np.empty([3,3]) 
np.zeros((3,3)) 
np.ones((3,3))  
np.eye(3)      
```


## 数据分析库 pandas

在数据分析中，数据通常以变量（一维数组，python中用序列表示）和矩阵（二维数组，
python中用数据框表示）的形式出现，下面结合python介绍pandas基本的数据操作。


注意：在python编程中，变量通常以列表（一组数据），而不是一般编程语言的标量（一个
数据）形式出现。

```{python}
import pandas as pd   
```


### 序列（series）
1. 创建序列（向量、一维数组）

假如要创建一个含有n个数值的向量（X=x1,x2…,xn），python中创建序列的函数是列表，
这些向量可以是数字型的，也可以是字符串型的，还可以是混合型的。

特别说明：python中显示数据或对象内容直接用其名称，见下。


2. 生成系列
```{python}
pd.Series()          
```


3. 根据列表构建序列
```{python}
X=[1,3,6,4,9]
S1=pd.Series(X);S1
S2=pd.Series(weight);S2
S3=pd.Series(sex);S3
```

4. 系列合并
```{python}
pd.concat([S2,S3],axis=0)    
pd.concat([S2,S3],axis=1)    
```

5. 系列切片
```{python}
S1[2]
S3[1:4]
```


### 数据框（DataFrame）
pandas中的函数DataFrameO可用序列构成一个数据框，如下页的df1和df2。数据框相当于关
系数据库中的结构化数据类型，传统的数据大都以结构化数据形式存储于关系数据库中，因
而传统的数据分析是以数据框为基础的。python中的数据分析大都是基于数据框进行的，所
以本书的分析也是以数据类型为主，向量和矩阵都可以看成数据框的一个特例。

1. 生成数据框
```{python}
pd.DataFrame()      
```

2. 根据列表创建数据框
```{python}
pd.DataFrame(X)
pd.DataFrame(X,columns=['X'],index=range(5))
pd.DataFrame(weight,columns=['weight'],index=['A','B','C','D','E'])
```

3. 根据字典创建数据框
```{python}
df1=pd.DataFrame({'S1':S1,'S2':S2,'S3':S3});df1
df2=pd.DataFrame({'sex':sex,'weight':weight},index=X);df2
```

4. 增加数据框列
```{python}
df2['weight2']=df2.weight**2; df2   
```

5. 删除数据框列
```{python}
del df2['weight2']; df2   
```

6. 缺失值处理
```{python}
df3=pd.DataFrame({'S2':S2,'S3':S3},index=S1);df3
df3.isnull()
df3.isnull().sum()
df3.dropna()   
#df3.dropna(how = 'all')
```

7. 数据框排序
```{python}
df3.sort_index()         
df3.sort_values(by='S3') 
```


### 数据框的读写

#### pandas读取数据集
大的数据对象常常从外部文件读入，而不是在python中直接输入的。外部的数据源有很多，
可以是电子表格、数据库、文本文件等形式。python的导入工具非常简单，但是对导入文件
有一些比较严格的限制。本书使用的是pandas包读取数据的方式，事先须调用pandas包，即
import pandas。


1. 从剪贴板上读取

前面讲到，电子表格是目前数据管理和编辑最方便的工具，所以可以考虑用电子表格管理数
据，用python分析数据，电子表格与python之间的数据交换（适用于全书）过程非常简单，
简述如下。

先在Dapy-data.xlsx数据文件的【BSdata】表中选取A1：H52，复制，然后在python中读取数据。
这里，BSdata为读入python中的数据框名，clipboard为剪贴板。
```{python, eval=F}
BSdata=pd.read_clipboard();
BSdata[:5]  
```

2. 读取csv格式数据

虽然python可以直接复制表格数据，但也可读取电子表格工作簿中的一个表格（例如，在
Excel中将数据Dapy-data.xlsx的表单［BSdata］另存为BSdata.csv，这时BSdata.csv本质
上也是文本文件，是以逗号分隔的文本数据，既可以用记事本打开，也可用电子表格软件打
开，是最通用的数据格式），其读取命令也最简单，如下所示。

```{python}
BSdata=pd.read_csv("../data/BSdata.csv",encoding='utf-8') 
BSdata[6:9]
```

3. 读取Excel格式数据

使用pandas包中的read-excel可直接读取Excel文档中的任意表单数据，其读取命令也比较
简单，例如，要读取Dapy-data.xlsx表单的［BSdata］,可用以下命令。

```{python}
BSdata=pd.read_excel('../data/DaPy_data.xlsx','BSdata');BSdata[-5:]
```

4. 读取其他统计软件的数据

要调用SAS、SSPS、Stata等统计软件的数据集，须先用相应的包，详见python手册。

#### pandas数据集的保存
python读取和保存数据集的最好方式是csv和xlsx文件格式，pandas保存数据的命令也很简单，如下所示。
```{python}
BSdata.to_csv('BSdata1.csv') 
```

### 数据框的操作

#### 基本信息
1. 数据框显示
   
有三种显示数据框内容的函数，即indoO(显示数据结构)、headO(显示数据框前5行)、tailO(显示数据框后5行)。
```{python}
BSdata.info()            
BSdata.head()            
BSdata.tail()            
```

1. 数据框列名（变量名）
```{python}
BSdata.columns           
```

2. 数据框行名（样品名）
```{python}
BSdata.index             
```

3. 数据框维度
```{python}
BSdata.shape             
BSdata.shape[0]          
BSdata.shape[1]          
```

4. 数据框值（数组）
```{python}
BSdata.values           
```


####  选取变量
选取数据框中变量的方法主要有以下几种。
1. “.”法或［‘’］法：这是python中最直观的选择变量的方法，比如，要选择数据框
   BSdata中的“身高”和“体重”变量，直接用“BSdata.身高”与“BSdata.体重”即可，
   也可用BSdata［‘身高’］与［‘体重’］，该方法书写比“.”法烦琐，却是最不容易
   出错且直观的一种方法，可推广到多个变量的情形，推荐使用。
   
2. 下标法：由于数据框是二维数组（矩阵）的扩展，所以也可以用矩阵的列下标来选取变
   量数据，这种方法进行矩阵(数据框)运算比较方便。例如，dat.iloc［i,j］表示数据框
   （矩阵）的第i行、第j列数据，dat.iloc［i,］表示dat的第i行数据向量，而
   dat.iloc[,j]表示dat的第j列数据向量（变量）。再如，“身高”和“体重”变量在数
   据框BSdata的第3、4两列。
   
```{python}

BSdata.身高 #取一列数据，BSdata['身高']

BSdata[['身高','体重']]  
BSdata.iloc[:,2] 
BSdata.iloc[:,2:4] 
```


#### 提取样品
```{python}
BSdata.loc[3] 
BSdata.loc[3:5] 
```


#### 选取观测与变量
同时选取观测与变量数据的方法就是将提取变量和样品方法结合使用。例如，要选取数据框
中男生的身高数据，可用以下语句。

```{python}
BSdata.loc[:3,['身高','体重']]
BSdata.iloc[:3,:5] 
```


#### 条件选取
例如，选取身高超过180cm的男生的数据，以及身高超过180cm且体重小于80kg的男生的数据，
可用以下语句。

```{python}
BSdata[BSdata['身高']>180]
BSdata[(BSdata['身高']>180)&(BSdata['体重']<80)]
```


#### 数据框的运算
1. 生成新的数据框

可以通过选择变量名来生成新的数据框。
```{python}
BSdata['体重指数']=BSdata['体重']/(BSdata['身高']/100)**2
round(BSdata[:5],2)
```

2.数据框的合并pd.concat()

可以用pd.concat()将两个或两个以上的向量、矩阵或数据框合并起来，参数axis=0表
示按行合并，axis=1表示按列合并。

①按行合并，axis=0。
```{python}
pd.concat([BSdata.身高, BSdata.体重],axis=0)
```

②按列合并，axis=1。
```{python}
pd.concat([BSdata.身高, BSdata.体重],axis=1)
```

3.数据框转置 .T。
```{python}
BSdata.iloc[:3,:5].T
```


## Python 编程运算
### 基本运算
与Basic语言、VB语言、C语言、C++语言等一样，python语言具有编程功能，但python是新
时期的编程语言，具有面向对象的功能，同时python还是面向函数的语言，这一点在3.3节
已有体现。既然python是一种编程语言，它就具有常规语言的算术运算符和逻辑运算符（如
表3-1所示），以及控制语句、自定义函数等功能。下面对python的编程特点做一些简单介
绍。

### 控制语句

编程离不开对程序的控制，下面介绍几个最常用的控制语句，其他控制语句见python手册。
#### 循环语句 for

python的for循环可以遍历任何序列的项目，如一个列表或一个字符串。for循环允许循环使
用向量或数列的每个值，在编程时非常有用。

for循环的语法格式如下：
 for iterating_var in sequence:
    statements(s)
python的for循环比其他语言的更为强大，例如：
```{python}
for i in range(1,5):
    print(i)

fruits = ['banana', 'apple',  'mango']
for fruit in fruits:
   print('当前水果 :', fruit)

for var in BSdata.columns:
    print(var)
```

#### 条件语句 if/else

if/else语句是分支语句中的主要语句，其格式如下：
```{python}
a = -100
if a < 100:
    print("数值小于100")
else:
    print("数值大于100")

-a if a<0 else a

```

python中有更简洁的形式来表达if/else语句。
注意：循环和条件等语句中要输出结果，请用print()函数，这时只用变量名是无法显示结
果的。

### 函数定义

在较复杂的计算问题中，有时一个任务可能需要重复多次，这时不妨自定义函数，这么做的
好处是，函数内的变量名是局部的，即函数运行结束后它们不再保存到当前的工作空间，这
就可以避免许多不必要的混淆和内存空间占用。python与其他统计软件的区别之一是，可以
随时随地自定义函数，而且可以像使用python的内置函数一样使用自定义的函数。


不同于SAS、SPSS等基于过程的统计软件，python进行数据分析是基于函数和面向对象的，
所有python的命令都是以函数形式出现的，比如读取文本数据的read-clipoard()函数和读
取csv数据文件的read-csv()函数，以及建立序列的Series()函数和构建数据框DataFrame()
函数。由于python是开源的，故所有函数使用者都可以查看其源代码。下面简单介绍python
的函数定义方法。定义函数的句法：

def 函数名（参数1，参数2，…）：
      函数体
      return

要学好python数据分析，就必须掌握python中的函数及其编程方法。表3-2所列是python中
常用的数学函数。


函数名可以是任意字符，但之前定义过的要小心使用，后定义的函数会覆盖先定义的函数。

注意：如果函数只用来计算，不需要返回结果，则可在函数中用print函数，这时只用变量
名是无法显示结果的，见下。一旦定义了函数名，就可以像python的其他函数一样使用，比
如，定义一个用来求一组数据的均值的函数，可以用于C、C++、VB等语言相同的方式定义，
但方便得多。如计算向量X=（x1,x2,…,xn）的均值函数：

$$\bar x=\frac{\sum_{i=1}^n x_i}{n}$$

代码如下：
```{python}
import numpy as np
x=[1,3,6,4,9,7,5,8,2];x
def xbar(x):
   n=len(x)
   xm=sum(x)/n
   return(xm)

xbar(x)
np.mean(x)
```

当然，python已内建这些函数命令，可直接使用，如下。其他统计函数计算见第4章。
要了解任何一个python函数，使用help()函数即可，例如，命令help(sum)或？sum将显示
sum()函数的使用帮助。

### 面向对象

python是一种面向对象的语言（一般使用者可不了解）。

前面介绍的序列（向量、一维数组），数据框（矩阵、二维数组）都是python的数据对象，
各种python函数也是对象。由于python函数的许多计算结果都放在对象中，这使得python的
结果通常比SAS、SPSS和Stata等数据分析软件的结果简洁，需要时才调用，为进一步分析提
供了方便。

下面就通过编写一个函数的过程来简单介绍python的函数自定义方法和面向对象技术。如计
算向量X=（x1,x2,…,xn）的离均差平方和函数：

```{python, eval=F}
def SS1(x):
    n=len(x)
    ss=sum(x**2)-sum(x)**2/n
    return(ss)

SS1(X) 

def SS2(x): 
    n=len(x)
    xm=sum(x)/n
    ss=sum(x**2)-sum(x)**2/n
    return[x**2,n,xm,ss]

SS2(X) 

SS2(X)[0] 
SS2(X)[1] 
SS2(X)[2] 
SS2(X)[3] 

type(SS2(X))
type(SS2(X)[3])
```

有了离均差平方和函数，就可做许多统计计算，如计算方差、标准差，进行方差分析等。该
函数用来计算一些常用的统计量协方差阵和相关系数阵。python一次可以返回多个数据对象，
例如，下面的函数可返回数据的均值、平方和、离差平方和、方差、标准差，但一般要用到
列表（list）类型。这里的列表是比数据框更高级的数据对象，相当于非结构化数据类型，
列表类型为大数据分析提供了便利，其原因是，大数据中很多数据都呈非结构化特点。下面
简单介绍python列表类型的用法，初学者可暂不学习。向量、矩阵和数组的元素必须是同一
类型的数据对象。如果一个数据对象需要包含不同类型的数据对象，可以采用列表的形式。
列表是一个对象的有序集合，列表中包含的对象又称为它的成分，成分可以是不同的模式和
类型，例如，一个列表可以包括数值向量、逻辑向量、矩阵、字符、数组和数据框等。列表
中对象的成分访问与数据基本一样，可以用下标获取，但不完全一样，在此不详述。可以使
用type()函数来查看数据或对象的类型。

